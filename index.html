<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingredient Inspector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Tailwind's default sans-serif is good */
        }
        /* Custom scrollbar for better aesthetics if needed */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #0D9488; /* Teal-700 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #0F766E; /* Teal-800 */
        }
        .tab-button.active {
            background-color: #0D9488; /* Teal-700 */
            color: white;
        }
        .tab-button {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #cameraFeed {
            transform: scaleX(-1); /* Mirror mode for selfie view */
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #0D9488; /* Teal-700 */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen flex flex-col items-center pt-8 pb-16 px-4">

    <div class="w-full max-w-3xl bg-white shadow-2xl rounded-xl p-6 md:p-10">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-teal-700">üåø Ingredient Inspector üî¨</h1>
            <p class="text-slate-600 mt-2 text-lg">Analyze food ingredients for a healthier choice.</p>
        </header>

        <!-- Input Section -->
        <section id="inputSection" class="mb-8">
            <h2 class="text-2xl font-semibold text-teal-600 mb-4 border-b-2 border-teal-200 pb-2">Step 1: Provide Ingredients</h2>
            
            <div class="mb-6">
                <div class="flex border-b border-slate-300">
                    <button id="tabUpload" class="tab-button active flex-1 py-3 px-4 text-center font-medium text-slate-700 hover:bg-teal-100 rounded-t-lg focus:outline-none">
                        ‚¨ÜÔ∏è Upload Image
                    </button>
                    <button id="tabCamera" class="tab-button flex-1 py-3 px-4 text-center font-medium text-slate-700 hover:bg-teal-100 rounded-t-lg focus:outline-none">
                        üì∏ Use Camera
                    </button>
                </div>

                <div id="uploadContent" class="py-6">
                    <label for="imageUpload" class="block mb-2 text-sm font-medium text-slate-700">Select an image of the ingredients label:</label>
                    <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-slate-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-lg file:border-0
                        file:text-sm file:font-semibold
                        file:bg-teal-50 file:text-teal-700
                        hover:file:bg-teal-100 cursor-pointer focus:outline-none focus:ring-2 focus:ring-teal-500 rounded-lg border border-slate-300 p-2.5">
                    <img id="imagePreview" src="#" alt="Image Preview" class="mt-4 rounded-lg shadow-md max-h-60 w-auto mx-auto hidden"/>
                </div>

                <div id="cameraContent" class="py-6 hidden">
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <button id="startCameraBtn" class="flex-1 bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-400">Start Camera</button>
                        <button id="stopCameraBtn" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-orange-400 hidden">Stop Camera</button>
                        <button id="captureImageBtn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-400 hidden">Capture Image</button>
                    </div>
                    <div class="bg-slate-200 rounded-lg overflow-hidden shadow-inner aspect-video max-h-[400px] mx-auto">
                        <video id="cameraFeed" playsinline class="w-full h-full object-cover"></video>
                    </div>
                    <canvas id="imageCanvas" class="hidden"></canvas> <!-- For capturing frame -->
                </div>
            </div>
        </section>

        <!-- Review Section -->
        <section id="reviewSection" class="mb-8">
            <h2 class="text-2xl font-semibold text-teal-600 mb-4 border-b-2 border-teal-200 pb-2">Step 2: Review & Analyze</h2>
            <label for="ingredientsText" class="block mb-2 text-sm font-medium text-slate-700">Extracted or manually entered ingredients (edit if needed):</label>
            <textarea id="ingredientsText" rows="8" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition duration-150 ease-in-out" placeholder="Text from image will appear here, or you can type/paste ingredients directly..."></textarea>
            <button id="analyzeBtn" class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 text-lg flex items-center justify-center">
                <span id="analyzeBtnText">‚ú® Analyze Ingredients</span>
                <div id="analyzeLoader" class="loader ml-3 hidden"></div>
            </button>
        </section>

        <!-- Status and Results Section -->
        <section id="resultsSection">
            <h2 class="text-2xl font-semibold text-teal-600 mb-4 border-b-2 border-teal-200 pb-2">Step 3: Analysis Results</h2>
            <div id="statusMessage" class="mb-6 p-4 rounded-lg text-sm min-h-[50px]"></div>
            <div id="analysisOutput" class="space-y-6">
                <!-- Analysis results will be injected here -->
            </div>
        </section>

         <footer class="mt-12 text-center text-xs text-slate-500">
            <p>Disclaimer: This analysis is AI-generated for informational purposes only and not a substitute for professional medical or nutritional advice.</p>
            <p>&copy; 2025 Ingredient Inspector. All rights reserved (conceptually).</p>
        </footer>
    </div>

    <script>
        // --- CONFIGURATION ---
        // IMPORTANT: Replace with your actual API keys
        const GOOGLE_VISION_API_KEY = ""; // Your Google Cloud Vision API Key
        const GEMINI_API_KEY = ""; // Your Google Generative AI (Gemini) API Key (if not using built-in auth)

        // --- DOM ELEMENTS ---
        const tabUpload = document.getElementById('tabUpload');
        const tabCamera = document.getElementById('tabCamera');
        const uploadContent = document.getElementById('uploadContent');
        const cameraContent = document.getElementById('cameraContent');
        
        const imageUploadInput = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        
        const startCameraBtn = document.getElementById('startCameraBtn');
        const stopCameraBtn = document.getElementById('stopCameraBtn');
        const captureImageBtn = document.getElementById('captureImageBtn');
        const cameraFeed = document.getElementById('cameraFeed');
        const imageCanvas = document.getElementById('imageCanvas');
        
        const ingredientsTextarea = document.getElementById('ingredientsText');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analyzeBtnText = document.getElementById('analyzeBtnText');
        const analyzeLoader = document.getElementById('analyzeLoader');
        
        const statusMessageDiv = document.getElementById('statusMessage');
        const analysisOutputDiv = document.getElementById('analysisOutput');

        let cameraStream = null;

        // --- TAB SWITCHING LOGIC ---
        tabUpload.addEventListener('click', () => {
            uploadContent.classList.remove('hidden');
            cameraContent.classList.add('hidden');
            tabUpload.classList.add('active');
            tabCamera.classList.remove('active');
            stopCamera(); // Stop camera if user switches tab
        });

        tabCamera.addEventListener('click', () => {
            cameraContent.classList.remove('hidden');
            uploadContent.classList.add('hidden');
            tabCamera.classList.add('active');
            tabUpload.classList.remove('active');
        });

        // --- STATUS & LOADING ---
        function showStatus(message, isError = false) {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = `mb-6 p-4 rounded-lg text-sm ${isError ? 'bg-red-100 text-red-700' : 'bg-sky-100 text-sky-700'}`;
        }

        function setLoading(buttonTextElement, loaderElement, isLoading, defaultText) {
            if (isLoading) {
                buttonTextElement.textContent = 'Processing...';
                loaderElement.classList.remove('hidden');
                analyzeBtn.disabled = true;
            } else {
                buttonTextElement.textContent = defaultText;
                loaderElement.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        }

        // --- IMAGE UPLOAD HANDLING ---
        imageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    ingredientsTextarea.value = ''; // Clear previous text
                    analysisOutputDiv.innerHTML = ''; // Clear previous results
                    showStatus('Image selected. Performing OCR...', false);
                    performOcr(e.target.result.split(',')[1]); // Pass base64 data
                }
                reader.readAsDataURL(file);
            } else {
                imagePreview.classList.add('hidden');
                imagePreview.src = "#";
            }
        });

        // --- CAMERA HANDLING ---
        startCameraBtn.addEventListener('click', async () => {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    cameraFeed.srcObject = cameraStream;
                    cameraFeed.classList.remove('hidden');
                    startCameraBtn.classList.add('hidden');
                    stopCameraBtn.classList.remove('hidden');
                    captureImageBtn.classList.remove('hidden');
                    showStatus('Camera started. Position the ingredients label.', false);
                } catch (error) {
                    console.error("Error accessing camera:", error);
                    showStatus(`Error accessing camera: ${error.name}. Please ensure permissions are granted.`, true);
                    if (error.name === "NotAllowedError") {
                         showStatus("Camera access was denied. Please allow camera access in your browser settings and refresh the page.", true);
                    } else if (error.name === "NotFoundError" || error.name === "DevicesNotFoundError") {
                        showStatus("No camera found. Please ensure a camera is connected and enabled.", true);
                    } else {
                        showStatus("Could not access the camera. Please check your browser settings and ensure a camera is available.", true);
                    }
                }
            } else {
                showStatus('Camera API not supported by your browser.', true);
            }
        });

        stopCameraBtn.addEventListener('click', stopCamera);

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraFeed.srcObject = null; // Clear the video feed
                cameraStream = null;
                startCameraBtn.classList.remove('hidden');
                stopCameraBtn.classList.add('hidden');
                captureImageBtn.classList.add('hidden');
                showStatus('Camera stopped.', false);
            }
        }
        
        captureImageBtn.addEventListener('click', () => {
            if (!cameraStream) {
                showStatus('Camera not active. Please start the camera first.', true);
                return;
            }
            const context = imageCanvas.getContext('2d');
            imageCanvas.width = cameraFeed.videoWidth;
            imageCanvas.height = cameraFeed.videoHeight;
            // Flip the image back to normal before drawing if it was mirrored for display
            context.save();
            if (cameraFeed.style.transform === 'scaleX(-1)') { // Check if mirrored
                context.scale(-1, 1);
                context.drawImage(cameraFeed, -imageCanvas.width, 0, imageCanvas.width, imageCanvas.height);
            } else {
                context.drawImage(cameraFeed, 0, 0, imageCanvas.width, imageCanvas.height);
            }
            context.restore();

            const imageDataUrl = imageCanvas.toDataURL('image/png');
            imagePreview.src = imageDataUrl; // Show captured image as preview
            imagePreview.classList.remove('hidden');
            ingredientsTextarea.value = ''; // Clear previous text
            analysisOutputDiv.innerHTML = ''; // Clear previous results
            showStatus('Image captured. Performing OCR...', false);
            performOcr(imageDataUrl.split(',')[1]); // Pass base64 data
            stopCamera(); // Optionally stop camera after capture
        });

        // --- OCR FUNCTION (Google Cloud Vision API) ---
        async function performOcr(base64ImageData) {
            if (!GOOGLE_VISION_API_KEY) {
                showStatus('Google Vision API Key is not configured. OCR cannot be performed.', true);
                setLoading(analyzeBtnText, analyzeLoader, false, '‚ú® Analyze Ingredients');
                return;
            }
            setLoading(analyzeBtnText, analyzeLoader, true, '‚ú® Analyze Ingredients'); // Use analyze button's loader
            
            const visionApiUrl = `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`;
            const requestPayload = {
                requests: [{
                    image: { content: base64ImageData },
                    features: [{ type: 'TEXT_DETECTION' }]
                }]
            };

            try {
                const response = await fetch(visionApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestPayload)
                });
                const result = await response.json();

                if (!response.ok || result.error || (result.responses && result.responses[0].error)) {
                    const errorMsg = result.error?.message || result.responses?.[0]?.error?.message || "Unknown Vision API error";
                    console.error('Google Vision API Error:', result);
                    showStatus(`OCR Error: ${errorMsg}`, true);
                    ingredientsTextarea.value = `OCR failed: ${errorMsg}`;
                    setLoading(analyzeBtnText, analyzeLoader, false, '‚ú® Analyze Ingredients');
                    return;
                }
                
                if (result.responses && result.responses[0] && result.responses[0].fullTextAnnotation) {
                    const detectedText = result.responses[0].fullTextAnnotation.text;
                    ingredientsTextarea.value = detectedText;
                    showStatus('OCR successful! Review the text and click Analyze.', false);
                } else {
                    ingredientsTextarea.value = '';
                    showStatus('No text detected by OCR or an unexpected response format.', false);
                }
            } catch (error) {
                console.error('Error calling Google Vision API:', error);
                showStatus(`Network or other error during OCR: ${error.message}`, true);
                ingredientsTextarea.value = `OCR failed: ${error.message}`;
            } finally {
                 setLoading(analyzeBtnText, analyzeLoader, false, '‚ú® Analyze Ingredients');
            }
        }

        // --- LLM ANALYSIS (Gemini API) ---
        analyzeBtn.addEventListener('click', async () => {
            const ingredients = ingredientsTextarea.value.trim();
            if (!ingredients) {
                showStatus('Please enter or extract some ingredients first.', true);
                return;
            }
            
            if (!GEMINI_API_KEY && !window.trustedTypes) { // Second condition for built-in auth
                 showStatus('Gemini API Key is not configured. Analysis cannot be performed.', true);
                 return;
            }

            showStatus('Analyzing ingredients with AI, please wait...', false);
            setLoading(analyzeBtnText, analyzeLoader, true, '‚ú® Analyze Ingredients');
            analysisOutputDiv.innerHTML = ''; // Clear previous results

            const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            const prompt = `
You are an expert food ingredient analyst. Analyze the following list of ingredients and provide a comprehensive health assessment.
Your response MUST be a single, valid JSON object. Do not include any text before or after the JSON structure (e.g., no "'''json" markers or explanations).

INGREDIENTS:
${ingredients}

JSON Structure Expected:
{
  "overall_health_score": <integer, 0-100, representing overall healthiness>,
  "potential_side_effects": ["<string effect1>", "<string effect2>", ... <array of strings describing potential side effects>],
  "ingredients_analysis": {
    "toxic_banned": [
      {"name": "<string ingredient_name>", "explanation": "<string explanation: what it is, why used, health effects>", "reference_url": "<optional string URL or null>"}
    ],
    "bad": [
      {"name": "<string ingredient_name>", "explanation": "<string explanation>", "reference_url": "<optional string URL or null>"}
    ],
    "average": [
      {"name": "<string ingredient_name>", "explanation": "<string explanation>", "reference_url": "<optional string URL or null>"}
    ],
    "good": [
      {"name": "<string ingredient_name>", "explanation": "<string explanation>", "reference_url": "<optional string URL or null>"}
    ],
    "healthy": [
      {"name": "<string ingredient_name>", "explanation": "<string explanation>", "reference_url": "<optional string URL or null>"}
    ]
  },
  "other_observations": ["<string observation1>", "<string observation2>", ... <array of strings for other relevant notes>],
  "conclusion": {
    "summary": "<string overall summary of the product's healthiness based on ingredients>",
    "alternatives": ["<string healthier alternative product type or ingredient suggestion1>", "<string alternative2>", ... <array of strings>]
  }
}

Ensure all string values are properly escaped for JSON. If a category (e.g., "toxic_banned") has no ingredients, provide an empty array [].
Base your analysis on scientific evidence and general nutritional guidelines. The overall_health_score should reflect the balance of healthy versus unhealthy ingredients.
For "reference_url", provide a URL to a reputable source if available for "toxic_banned" items, otherwise use null. For other categories, reference_url is optional.
            `;

            const payload = {
              contents: [{ role: "user", parts: [{ text: prompt }] }],
              generationConfig: {
                responseMimeType: "application/json",
                // Define the schema for the expected JSON response
                responseSchema: {
                  type: "OBJECT",
                  properties: {
                    "overall_health_score": { "type": "NUMBER" },
                    "potential_side_effects": { "type": "ARRAY", "items": { "type": "STRING" } },
                    "ingredients_analysis": {
                      "type": "OBJECT",
                      properties: {
                        "toxic_banned": {
                          "type": "ARRAY",
                          "items": {
                            "type": "OBJECT",
                            "properties": {
                              "name": { "type": "STRING" },
                              "explanation": { "type": "STRING" },
                              "reference_url": { "type": "STRING", "nullable": true, "description": "URL to a reputable source or null" }
                            },
                            "required": ["name", "explanation"]
                          }
                        },
                        "bad": { /* Same structure as toxic_banned */ "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "name": { "type": "STRING" }, "explanation": { "type": "STRING" }, "reference_url": { "type": "STRING", "nullable": true } }, "required": ["name", "explanation"] } },
                        "average": { /* Same structure as toxic_banned */ "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "name": { "type": "STRING" }, "explanation": { "type": "STRING" }, "reference_url": { "type": "STRING", "nullable": true } }, "required": ["name", "explanation"] } },
                        "good": { /* Same structure as toxic_banned */ "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "name": { "type": "STRING" }, "explanation": { "type": "STRING" }, "reference_url": { "type": "STRING", "nullable": true } }, "required": ["name", "explanation"] } },
                        "healthy": { /* Same structure as toxic_banned */ "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "name": { "type": "STRING" }, "explanation": { "type": "STRING" }, "reference_url": { "type": "STRING", "nullable": true } }, "required": ["name", "explanation"] } }
                      },
                       "required": ["toxic_banned", "bad", "average", "good", "healthy"]
                    },
                    "other_observations": { "type": "ARRAY", "items": { "type": "STRING" } },
                    "conclusion": {
                      "type": "OBJECT",
                      properties: {
                        "summary": { "type": "STRING" },
                        "alternatives": { "type": "ARRAY", "items": { "type": "STRING" } }
                      },
                      "required": ["summary", "alternatives"]
                    }
                  },
                  "required": ["overall_health_score", "potential_side_effects", "ingredients_analysis", "other_observations", "conclusion"]
                }
              }
            };
            
            try {
                const response = await fetch(geminiApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (!response.ok || (result.candidates && result.candidates.length > 0 && result.candidates[0].finishReason !== "STOP" && result.candidates[0].finishReason !== undefined) || result.error) {
                     const errorDetail = result.error?.message || (result.promptFeedback?.blockReason?.toString()) || (result.candidates?.[0]?.finishReason) || "Unknown Gemini API error";
                     console.error('Gemini API Error Response:', result);
                     showStatus(`Analysis Error: ${errorDetail}. The model might have been blocked or an API issue occurred.`, true);
                     analysisOutputDiv.innerHTML = `<p class="text-red-600">Analysis failed: ${errorDetail}</p>`;
                     return;
                }

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0].text) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    try {
                        const analysisData = JSON.parse(jsonText);
                        displayAnalysisResults(analysisData, ingredients);
                        showStatus('Analysis complete!', false);
                    } catch (parseError) {
                        console.error("Error parsing JSON from Gemini:", parseError, "\nReceived text:", jsonText);
                        showStatus('Error processing analysis results: Could not parse JSON response from AI.', true);
                        analysisOutputDiv.innerHTML = `<p class="text-red-600 font-semibold">Error: Failed to parse AI's response.</p><p class="text-xs text-slate-500 mt-2">Received (partial):</p><pre class="bg-slate-100 p-2 rounded text-xs whitespace-pre-wrap">${jsonText.substring(0, 500)}...</pre>`;
                    }
                } else {
                    console.error('Unexpected Gemini API response structure:', result);
                    showStatus('Analysis failed: Unexpected response structure from AI.', true);
                    analysisOutputDiv.innerHTML = `<p class="text-red-600">Analysis failed due to unexpected AI response format.</p>`;
                }

            } catch (error) {
                console.error('Error calling Gemini API:', error);
                showStatus(`Network or other error during analysis: ${error.message}`, true);
            } finally {
                setLoading(analyzeBtnText, analyzeLoader, false, '‚ú® Analyze Ingredients');
            }
        });

        // --- DISPLAY ANALYSIS RESULTS ---
        function displayAnalysisResults(data, originalIngredients) {
            analysisOutputDiv.innerHTML = ''; // Clear previous

            // Overall Score
            const score = data.overall_health_score !== undefined ? data.overall_health_score : 'N/A';
            let scoreColor = 'text-slate-700';
            if (typeof score === 'number') {
                if (score >= 70) scoreColor = 'text-green-600';
                else if (score >= 40) scoreColor = 'text-yellow-600';
                else scoreColor = 'text-red-600';
            }
            const scoreDiv = document.createElement('div');
            scoreDiv.className = 'text-center mb-8 p-6 bg-slate-50 rounded-xl shadow';
            scoreDiv.innerHTML = `
                <p class="text-xl font-semibold text-slate-700 mb-2">Overall Health Score</p>
                <p class="text-6xl font-bold ${scoreColor}">${score}<span class="text-3xl">/100</span></p>
            `;
            analysisOutputDiv.appendChild(scoreDiv);

            // Original Ingredients (collapsible)
            const ogDiv = document.createElement('div');
            ogDiv.className = 'mb-6 bg-slate-50 p-4 rounded-lg shadow';
            ogDiv.innerHTML = `
                <details>
                    <summary class="font-semibold text-teal-700 cursor-pointer hover:text-teal-600">Original Ingredients Submitted</summary>
                    <p class="mt-2 text-sm text-slate-600 whitespace-pre-wrap bg-white p-3 rounded border border-slate-200">${originalIngredients}</p>
                </details>
            `;
            analysisOutputDiv.appendChild(ogDiv);


            // Helper to create list sections
            function createListSection(title, items, listClasses = 'list-disc list-inside space-y-1 text-slate-700', itemClasses = '') {
                if (!items || items.length === 0) return '';
                let itemsHtml = items.map(item => `<li class="${itemClasses}">${item}</li>`).join('');
                return `
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-teal-700 mb-2">${title}</h4>
                        <ul class="${listClasses}">${itemsHtml}</ul>
                    </div>
                `;
            }
            
            // Helper to create ingredient category sections
            function createIngredientCategorySection(title, ingredients, colorClass = 'border-slate-500') {
                if (!ingredients || ingredients.length === 0) {
                     return `<div class="mb-4"><h4 class="text-md font-semibold text-teal-700">${title}</h4><p class="text-sm text-slate-500 italic">None identified in this category.</p></div>`;
                }
                let itemsHtml = ingredients.map(ing => `
                    <li class="mb-3 p-3 bg-white rounded-md shadow-sm border-l-4 ${colorClass}">
                        <strong class="block text-slate-800">${ing.name}</strong>
                        <p class="text-sm text-slate-600 mt-1">${ing.explanation}</p>
                        ${ing.reference_url ? `<a href="${ing.reference_url}" target="_blank" rel="noopener noreferrer" class="text-xs text-sky-600 hover:text-sky-700 hover:underline mt-1 block">Learn more</a>` : ''}
                    </li>
                `).join('');
                return `
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-teal-700 mb-3">${title}</h4>
                        <ul class="space-y-2">${itemsHtml}</ul>
                    </div>
                `;
            }

            analysisOutputDiv.innerHTML += createListSection('Potential Side Effects', data.potential_side_effects);

            const ia = data.ingredients_analysis;
            if (ia) {
                const ingredientsSection = document.createElement('div');
                ingredientsSection.className = 'p-4 bg-sky-50 rounded-lg shadow-inner';
                ingredientsSection.innerHTML = `<h3 class="text-xl font-semibold text-sky-700 mb-4">Detailed Ingredient Breakdown</h3>`;
                ingredientsSection.innerHTML += createIngredientCategorySection('Toxic / Banned', ia.toxic_banned, 'border-red-500');
                ingredientsSection.innerHTML += createIngredientCategorySection('Bad', ia.bad, 'border-orange-500');
                ingredientsSection.innerHTML += createIngredientCategorySection('Average', ia.average, 'border-yellow-500');
                ingredientsSection.innerHTML += createIngredientCategorySection('Good', ia.good, 'border-lime-500');
                ingredientsSection.innerHTML += createIngredientCategorySection('Healthy', ia.healthy, 'border-green-500');
                analysisOutputDiv.appendChild(ingredientsSection);
            }
            
            analysisOutputDiv.innerHTML += createListSection('Other Observations', data.other_observations);

            if (data.conclusion) {
                const conclusionDiv = document.createElement('div');
                conclusionDiv.className = 'mt-6 p-6 bg-teal-50 rounded-xl shadow';
                conclusionDiv.innerHTML = `
                    <h3 class="text-xl font-semibold text-teal-700 mb-3">Conclusion & Alternatives</h3>
                    <p class="text-slate-700 mb-4"><strong class="block text-teal-600">Summary:</strong> ${data.conclusion.summary}</p>
                    ${data.conclusion.alternatives && data.conclusion.alternatives.length > 0 ? createListSection('Healthier Alternatives:', data.conclusion.alternatives, 'list-disc list-inside space-y-1 text-slate-700') : '<p class="text-sm text-slate-500 italic">No specific alternatives suggested.</p>'}
                `;
                analysisOutputDiv.appendChild(conclusionDiv);
            }
        }

        // --- INITIALIZATION ---
        showStatus('Ready to analyze. Upload an image, use your camera, or type ingredients.', false);

    </script>
</body>
</html>
